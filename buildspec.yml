version: 0.2
phases:
  install:
    runtime-versions:
      nodejs: 18
    commands:
      - npm install -g pnpm@7.13.0
      - npm install -g @microsoft/rush
      - npm install -g aws-cdk
      - export PATH=$PATH:$(npm bin -g)
      - export AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query "Account" --output text)
      - echo "ENV=$ENV"
      - echo "CODE_BUILD_ROLE=$CODE_BUILD_ROLE"
      - echo "STAGE_TYPE=$STAGE_TYPE"
      - echo "STAGE_NAME=$STAGE_NAME"
      - echo "USERPOOL_ID=$USERPOOL_ID"
      - echo "USERPOOL_CLIENT_ID=$USERPOOL_CLIENT_ID"
      - echo "POOL_DOMAIN=$POOL_DOMAIN"
      - echo "AWS_REGION=$AWS_REGION"
      - echo "ALL_TENANTS_SCOPE=$ALL_TENANTS_SCOPE"
      - export CDK_TOOLKIT_STACK_NAME=cdk-toolkit-$STAGE_NAME
  pre_build:
    commands:
      - echo "Validating CDK bootstrap template"
      # Cannot use CDK bootstrap with custom parameters, which are needed to assume the CDK Toolkit roles for deployment from CodeBuild
      # - cdk bootstrap aws://$AWS_ACCOUNT_ID/$AWS_REGION --template bootstrap-template.yaml -c Env=$ENV
      - aws cloudformation validate-template --template-body file://bootstrap-template.yaml
      # - |
      #   aws cloudformation create-stack \
      #     --stack-name CDKToolkit \
      #     --template-body file://bootstrap-template.yaml \
      #     --capabilities CAPABILITY_NAMED_IAM \
      #     --region $AWS_REGION \
      #     --parameters ParameterKey=Env,ParameterValue=$ENV
      - echo "Bootstrapping CDK environment"
      - |
        cdk bootstrap aws://$AWS_ACCOUNT_ID/$AWS_REGION \
          --template-body file://bootstrap-template.yaml \
          --toolkit-stack-name $CDK_TOOLKIT_STACK_NAME \
          --qualifier $Env
      - echo "Updating CDK role trust policies"
      - cd deployment && chmod +x ./update-cdk-role-trust-policy.sh && ./update-cdk-role-trust-policy.sh $AWS_ACCOUNT_ID $CDK_TOOLKIT_STACK_NAME $CODE_BUILD_ROLE
      - echo "Installing dependencies and executing unit tests - `pwd`"
      - chmod +x ./run-unit-tests.sh && ./run-unit-tests.sh
      - echo "Installing dependencies and executing unit tests completed `date`"
  build:
    commands:
      # - echo "Starting build `date` `pwd`"
      # - chmod +x ./build-s3-dist.sh && ./build-s3-dist.sh $DIST_OUTPUT_BUCKET $SOLUTION_NAME $VERSION
      # - echo "Build completed `date`"
      # - echo "Starting open-source-dist `date` `pwd`"
      # - chmod +x ./build-open-source-dist.sh && ./build-open-source-dist.sh $SOLUTION_NAME
      # - echo "Open Source Dist completed `date`"
      #- cd ..
      #- rush update # && rush build && rush test
  post_build:
    commands:
      - ls -al
      - cd ../solutions/deployment
      - ls -al
      - |
        rushx deploy -c region=$AWS_REGION \
          -c extUserPoolId=$USERPOOL_ID \
          -c extUserPoolClientId=$USERPOOL_CLIENT_ID \
          -c extUserPoolDomain=$POOL_DOMAIN \
          -c stage=$STAGE_NAME \
          -c stageType=$STAGE_TYPE \
          -c grantAccessAllTenantsScope=$ALL_TENANTS_SCOPE \
          -c enableMultiTenancy=true
      - echo "FHIRworks deployment succeeded"
      - echo "Setting SSM parameter $STAGE_NAME-fhirworks-url"
      - cd ../../deployment && chmod +x ./set-fhir-svc-ssm-param.sh && ./set-fhir-svc-ssm-param.sh $STAGE_NAME

  # post_build:
  #   commands:
  #     - echo "Retrieving next stage buildspec `date` `pwd`"
  #     - aws s3 cp s3://solutions-build-assets/changelog-spec.yml ../buildspec.yml
  #     - echo "Retrieving next stage buildspec complete"
  #     - echo "Post build completed on `date`"

artifacts:
  files:
    - solutions/**/*
    - fwoa-core/**/*
    - core/**/*
    - deployment/**/*
    - fwoa-tools/**/*
    - fwoa-utilities/**/*
    - solutions/**/*
    - buildspec-deploy.yml
    - buildspec.yml
    - CHANGELOG.md
    - LICENSE
    - NOTICE
    - CODE_OF_CONDUCT.md
    - CONTRIBUTING.md
    - README.md
    - .github/**/*
    - sonar-project.properties
    - .cfnnag_global_suppress_list
